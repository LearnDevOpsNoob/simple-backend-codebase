name: Deploy backend to EC2

# This triggers the workflow whenever you push to the 'main' branch
on:
  push:
    branches:
      - main    

jobs:
  deploy:
    name: Deploy backend to EC2
    runs-on: ubuntu-latest   # This runs the job on a GitHub-hosted Ubuntu server

    steps: 
      # Step 1: Check out the code (good practice even if not directly used)
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Save your EC2 private key securely on the runner
      - name: Add SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > ec2-key.pem
          chmod 600 ec2-key.pem
          # GitHub needs this private key to connect to your EC2 instance

      # Step 3: SSH into EC2 and run deployment commands
      - name: Connect to EC2 and Deploy
        run: |
          ssh -o StrictHostKeyChecking=no -i ec2-key.pem ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            cd ${{ secrets.EC2_APP_DIR }}

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            nvm use --lts

            # Confirm the key file exists and permissions are correct
            echo "🔐 Verifying SSH key:"
            ls -l ~/.ssh/id_ed25519_github
            chmod 600 ~/.ssh/id_ed25519_github

            # Set GIT_SSH_COMMAND to use correct key
            GIT_SSH_COMMAND='ssh -i ~/.ssh/id_ed25519_github -o IdentitiesOnly=yes' git pull origin main

            npm install
            nohup node server.js > output.log 2>&1 &
          EOF

      # This final step connects to EC2, updates code, installs packages, and starts the server
